!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("ethers"),require("elliptic"),require("jsrsasign"),require("buffer")):"function"==typeof define&&define.amd?define(["exports","ethers","elliptic","jsrsasign","buffer"],e):e((r||self).kalpWalletTs={},r.ethers,r.elliptic,r.jsrsasign,r.buffer)}(this,function(r,e,t,n,o){var i="p256",c="hex",s="pkcs8",u="f5b1aca0717e01d0dbca408d281e9e5145250acb146ff9f0844d53e95aab30b5",a="/pki/register",l="/pki/enrollCsr",h="sign",f="ECDSA",m="P-256",v="verify";function g(r,e){try{var t=r()}catch(r){return e(r)}return t&&t.then?t.then(void 0,e):t}var P,d=function(r,e){try{try{var s,u,a=n.KEYUTIL.getKey(r).prvKeyHex,l=new t.ec(i),h=l.keyFromPrivate(a,c),f=l.sign(o.Buffer.from(e),h);return s=f.r.toString(),u=f.s.toString(),Promise.resolve([s,u])}catch(r){throw Error("An error occurred in signUsingElliptic function:"+r)}}catch(r){return Promise.reject(r)}},p=function(r){try{try{for(var e={},t=0;t<64;t++)e["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[t]]=t;e["="]=0;for(var n=new Uint8Array(r.length),o=0,i=0;i<r.length;i+=4){var c=e[r[i+1]],s=e[r[i+2]],u=e[r[i+3]];n[o]=e[r[i]]<<2|c>>4,o++,"="!==r[i+2]&&(n[o]=c<<4|s>>2,o++),"="!==r[i+3]&&(n[o]=s<<6|u,o++)}return Promise.resolve(n.slice(0,o))}catch(r){throw Error("An error occurred in decodeBase64String function:"+r)}}catch(r){return Promise.reject(r)}},y=function(r,e){try{return Promise.resolve(g(function(){return Promise.resolve(fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).then(function(e){return Promise.resolve(e.json()).then(function(t){if(e.ok)return t;if(null!==t)throw Error("An error occurred while pinging url: "+r+",  message: "+JSON.stringify(t));throw Error("An error occurred while pinging url: "+r)})})},function(r){throw Error("An error occurred in restCall :"+r)}))}catch(r){return Promise.reject(r)}},w=function(r,e,t,n){try{return Promise.resolve(g(function(){return Promise.resolve(y(e,n)).then(function(e){var n=e.message.proposal;return Promise.resolve(p(n)).then(function(e){return Promise.resolve(d(r,e)).then(function(r){return Promise.resolve(y(t,{signedR:r[0],signedS:r[1],proposal:n})).then(function(r){return r.message.evaluate})})})})},function(r){throw Error("An error occurred while evaluateSignedTransaction :"+r)}))}catch(r){return Promise.reject(r)}},E=function(r){try{return Promise.resolve(g(function(){var e=(new TextEncoder).encode(r);return Promise.resolve(P.subtle.digest("SHA-256",e)).then(function(r){var e=function(r){return Array.from(new Uint8Array(r)).map(function(r){return r.toString(16).padStart(2,"0")}).join("")}(r),t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n="abcdefghijklmnopqrstuvwxyz",o="!@#$%^&*+-=",i="0123456789";function c(r,e){var t=parseInt(r.slice(2*e,2*e+2),16)%s.length;return s[t]}var s=t+n+o+i,u="";u+=t[parseInt(e.slice(0,2),16)%26],u+=n[parseInt(e.slice(2,4),16)%26],u+=o[parseInt(e.slice(4,6),16)%11],u+=i[parseInt(e.slice(6,8),16)%10];for(var a=4;a<16;a++)u+=c(e,a);return u})},function(r){throw Error("An error occurred while getting secret from enrollment ID "+r)}))}catch(r){return Promise.reject(r)}},A=function(r){try{return Promise.resolve(g(function(){return Promise.resolve(P.subtle.exportKey("spki",r)).then(function(r){return Promise.resolve(function(r){try{try{var e=String.fromCharCode.apply(null,new Uint8Array(r)),t=btoa(e);return Promise.resolve("-----BEGIN PUBLIC KEY-----\n"+t+"\n-----END PUBLIC KEY-----\n")}catch(r){throw Error("An error occurred while formatting base64key to pem key"+r)}}catch(r){return Promise.reject(r)}}(r))})},function(r){throw Error("An error occurred while converting publicKey from cryptoKey format to pem: "+r)}))}catch(r){return Promise.reject(r)}};P="undefined"==typeof window?require("crypto"):window.crypto;var b={Stagenet:"STAGENET",Testnet:"TESTNET",Mainnet:"MAINNET",IntegrationManinet:"INTEGRATIONMAINNET"};function S(r){switch(r){case b.Stagenet:return"https://dev-userreg-gov.p2eppl.com/v1";case b.IntegrationManinet:return"https://stg-userreg-gov.p2eppl.com/v1";case b.Testnet:return"https://ngl-userreg-test.kalp.network/v1";default:throw Error("An error occurred while getting network governance url :invalid environment variable passed")}}function j(r){switch(r){case b.Stagenet:return"https://stg-kalp-gateway.p2eppl.com/transaction/v1";case b.IntegrationManinet:return"https://intmainnet-kalp-gateway.p2eppl.com/transaction/v1";case b.Testnet:return"https://rpc-mumbai-test.kalp.network/transaction/v1";default:throw Error("An error occurred while getting kalp gateway url :invalid environment variable passed")}}function I(r){try{switch(r){case b.IntegrationManinet:return"intmainnet-mailabs";case b.Stagenet:return"kalpstagenet";case b.Testnet:return"prod-test-mainnet";default:throw Error("An error occurred while getting kalp gateway url :invalid environment variable passed")}}catch(r){throw r}}r.Network=b,r.createCsr=function(r,e,t){try{return new n.KJUR.asn1.csr.CertificationRequest({subject:{str:"/CN="+r+"/O=Your Organization/postalCode=Your Postal Code/L=Your Locality/ST=Your Province/C=IN"},sbjpubkey:t,sigalg:"SHA256withECDSA",sbjprvkey:e}).getPEM()}catch(r){throw Error("An error occurred while Creating CSR :"+r)}},r.enrollCsr=function(r,e,t,n,o,i){try{return Promise.resolve(g(function(){var c=(e||S(r))+l,s={Authorization:u},a={enrollmentid:n,secret:o,csr:i,channel:t||I(r)};return Promise.resolve(fetch(c,{method:"POST",headers:s,body:JSON.stringify(a)})).then(function(r){return r.ok?Promise.resolve(r.json()).then(function(r){return r.response.pubcert}):Promise.resolve(r.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while getting certificate"+e)})})},function(r){throw Error("An error occurred while getting certificate"+r)}))}catch(r){return Promise.reject(r)}},r.evaluateBalance=function(r,e,t,n,o,i,c,s,u){try{return Promise.resolve(g(function(){var a=e||j(r);return Promise.resolve(w(n,a+"/proposal",a+"/evaluate",{enrollmentID:t,cert:o,channelName:i,chainCodeName:c,transactionName:s,transactionParams:u}))},function(r){throw Error("An error occurred while getting balance :"+r)}))}catch(r){return Promise.reject(r)}},r.evaluateTransaction=function(r,e,t,n,o,i,c,s,u){try{return Promise.resolve(g(function(){var a=e||j(r);return Promise.resolve(w(n,a+"/proposal",a+"/evaluate",{enrollmentID:t,cert:o,channelName:i,chainCodeName:c,transactionName:s,transactionParams:u}))},function(r){throw Error("An error occurred while evaluating transaction :"+r)}))}catch(r){return Promise.reject(r)}},r.getEnrollmentId=function(r){try{return Promise.resolve(g(function(){var e=r.replace(/-----BEGIN PUBLIC KEY-----\r?\n|\r?\n?-----END PUBLIC KEY-----\r?\n?|\r?\n/g,"");return Promise.resolve(p(e)).then(function(r){return Promise.resolve(function(r){try{return Promise.resolve(g(function(){var e=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);return Promise.resolve(P.subtle.digest("SHA-256",e)).then(function(r){return new Uint8Array(r)})},function(r){throw Error("An error occurred while getting hashByteArray"+r)}))}catch(r){return Promise.reject(r)}}(r)).then(function(r){return Promise.resolve(function(r){try{try{for(var e=new Uint8Array(2*r.length),t=0;t<r.length;t++){var n=r[t];e[2*t]=n>>4&15,e[2*t+1]=15&n}return Promise.resolve(Array.from(e).map(function(r){return r.toString(16)}).join(""))}catch(r){throw Error("An error occurred in convertByteArrayToString function"+r)}}catch(r){return Promise.reject(r)}}(r)).then(function(r){return r.slice(-40)})})})},function(r){throw Error("An error occurred while getting enrollmentId : "+r)}))}catch(r){return Promise.reject(r)}},r.getKeyPair=function(){try{return Promise.resolve(g(function(){return Promise.resolve(function(){try{return Promise.resolve(g(function(){return Promise.resolve(window.crypto.subtle.generateKey({name:f,namedCurve:m},!0,[h,v]))},function(r){throw Error("An error occurred while generating key pair from generateKeyPairUsingCryptoSubtle function"+r)}))}catch(r){return Promise.reject(r)}}()).then(function(r){var e=r.privateKey;return Promise.resolve(A(r.publicKey)).then(function(r){return Promise.resolve(function(r){try{return Promise.resolve(g(function(){return Promise.resolve(P.subtle.exportKey(s,r)).then(function(r){var e=String.fromCharCode.apply(null,new Uint8Array(r));return"-----BEGIN PRIVATE KEY-----\n"+btoa(e)+"\n-----END PRIVATE KEY-----\n"})},function(r){throw Error("An error occurred in exportPrivateKeyAsPem function :"+r)}))}catch(r){return Promise.reject(r)}}(e)).then(function(e){return{pemPrivateKey:e,pemPublicKey:r}})})})},function(r){throw Error("An error occurred while getting public and private key pair:"+r)}))}catch(r){return Promise.reject(r)}},r.getKeyPairFromSeedPhrase=function(r){try{return Promise.resolve(g(function(){var o=new t.ec(i),s=e.ethers.utils.mnemonicToSeed(r),u=o.keyFromPrivate(s),a=u.getPrivate(c),l=u.getPublic(c),h=n.KEYUTIL.getKey({curve:"secp256r1",d:a}),d=n.KEYUTIL.getPEM(h,"PKCS8PRV");return Promise.resolve(function(r){try{return Promise.resolve(g(function(){for(var e=new Uint8Array(r.length/2),t=0;t<r.length;t+=2)e[t/2]=parseInt(r.substr(t,2),16);return Promise.resolve(P.subtle.importKey("raw",e,{name:f,namedCurve:m},!0,[v])).then(function(r){return Promise.resolve(A(r))})},function(r){throw Error("An error occurred while converting public key hex format to pem"+r)}))}catch(r){return Promise.reject(r)}}(l)).then(function(r){return{pemPrivateKey:d,pemPublicKey:r}})},function(r){throw Error("An error occurred while getting keypair:"+r)}))}catch(r){return Promise.reject(r)}},r.getRandSvalue=function(r,e){try{return Promise.resolve(g(function(){return Promise.resolve(function(r){try{return Promise.resolve(g(function(){for(var e=r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----",""),t=atob(e),n=new Uint8Array(t.length),o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return Promise.resolve(P.subtle.importKey(s,n.buffer,{name:f,namedCurve:m},!0,[h]))},function(r){throw Error("An error occurred in importPrivateKey function :"+r)}))}catch(r){return Promise.reject(r)}}(r)).then(function(r){return Promise.resolve(p(e)).then(function(e){return Promise.resolve(d(r,e)).then(function(r){return[r[0],r[1]]})})})},function(r){throw Error("An error occurred while getting R and S value :"+r)}))}catch(r){return Promise.reject(r)}},r.getSecret=E,r.getSeedPhrase=function(){try{try{var r=e.ethers.Wallet.createRandom();return Promise.resolve(r.mnemonic.phrase)}catch(r){throw Error("An error occurred while getting seedphrase: "+r)}}catch(r){return Promise.reject(r)}},r.register=function(r,e,t,n,o){try{return Promise.resolve(g(function(){if(40!==n.length)throw Error("Invalid enrollment ID: Must be 40 characters long.");var i=(e||S(r))+a,c={Authorization:u},s={enrollmentid:n,secret:o,maxenrollments:"-1",channel:t||I(r)};return Promise.resolve(fetch(i,{method:"POST",headers:c,body:JSON.stringify(s)})).then(function(r){function e(e){return Promise.resolve(r.json()).then(function(r){return JSON.stringify(r)})}var t=function(){if(!r.ok)return Promise.resolve(r.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while doing user registration"+e)})}();return t&&t.then?t.then(e):e()})},function(r){throw Error("An error occurred while doing user registration"+r)}))}catch(r){return Promise.reject(r)}},r.registerAndEnrollUser=function(r,e,t,n,o){try{return Promise.resolve(g(function(){if(40!==n.length)throw Error("Invalid enrollment ID: Must be 40 characters long.");return Promise.resolve(E(n)).then(function(i){var c=e||S(r),s=c+a,h={Authorization:u},f={enrollmentid:n,secret:i,maxenrollments:"-1",channel:t||I(r)};return Promise.resolve(fetch(s,{method:"POST",headers:h,body:JSON.stringify(f)})).then(function(e){if(e.ok){var s=c+l,a={Authorization:u},h={enrollmentid:n,secret:i,csr:o,channel:t||I(r)};return Promise.resolve(fetch(s,{method:"POST",headers:a,body:JSON.stringify(h)})).then(function(r){return r.ok?Promise.resolve(r.json()).then(function(r){return r.response.pubcert}):Promise.resolve(r.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while getting certificate"+e)})})}return Promise.resolve(e.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while doing user registration"+e)})})})},function(r){throw Error("An error occurred in user registration process "+r)}))}catch(r){return Promise.reject(r)}},r.signUsingElliptic=d,r.submitTransaction=function(r,e,t,n,o,i,c,s,u){try{return Promise.resolve(g(function(){console.log("transaction 123",r,e,t,n,o,i,c,s,u);var a=e||j(r),l=a+"/proposal",h=a+"/endorse",f=a+"/submit",m=a+"/commitstatus",v=n,g={enrollmentID:t,cert:o,channelName:i,chainCodeName:c,transactionName:s,transactionParams:u};return console.log("transaction",g),Promise.resolve(y(l,g)).then(function(r){var e="",t="",n=r.message.proposal;return Promise.resolve(p(n)).then(function(r){return Promise.resolve(d(v,r)).then(function(r){return e=r[0],t=r[1],Promise.resolve(y(h,{signedR:e,signedS:t,proposal:n})).then(function(r){var n=r.message.endorse;return Promise.resolve(p(n)).then(function(r){return Promise.resolve(d(v,r)).then(function(r){return e=r[0],t=r[1],Promise.resolve(y(f,{signedR:e,signedS:t,endorse:n})).then(function(r){var n=r.message.submit;return Promise.resolve(p(n)).then(function(r){return Promise.resolve(d(v,r)).then(function(r){return e=r[0],t=r[1],Promise.resolve(y(m,{signedR:e,signedS:t,submit:n})).then(function(r){var e=function(r){return r.message.transaction_id}(r);return e})})})})})})})})})})},function(r){throw Error("An error occurred while submiting transaction "+r)}))}catch(r){return Promise.reject(r)}}});
