import{ethers as r}from"ethers";import{ec as e}from"elliptic";import{KEYUTIL as n,KJUR as t}from"jsrsasign";import{Buffer as o}from"buffer";var i="p256",c="hex",s="pkcs8",u="f5b1aca0717e01d0dbca408d281e9e5145250acb146ff9f0844d53e95aab30b5",a="/pki/register",l="/pki/enrollCsr",h="sign",m="ECDSA",f="P-256",v="verify";function g(r,e){try{var n=r()}catch(r){return e(r)}return n&&n.then?n.then(void 0,e):n}var P,d=function(r,e){try{return Promise.resolve(g(function(){return Promise.resolve(y(r)).then(function(r){return Promise.resolve(w(e)).then(function(e){return Promise.resolve(p(r,e)).then(function(r){return[r[0],r[1]]})})})},function(r){throw Error("An error occurred while getting R and S value :"+r)}))}catch(r){return Promise.reject(r)}},p=function(r,t){try{try{var s,u,a=n.getKey(r).prvKeyHex,l=new e(i),h=l.keyFromPrivate(a,c),m=l.sign(o.from(t),h);return s=m.r.toString(),u=m.s.toString(),Promise.resolve([s,u])}catch(r){throw Error("An error occurred in signUsingElliptic function:"+r)}}catch(r){return Promise.reject(r)}},y=function(r){try{return Promise.resolve(g(function(){for(var e=r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----",""),n=atob(e),t=new Uint8Array(n.length),o=0;o<n.length;o++)t[o]=n.charCodeAt(o);return Promise.resolve(P.subtle.importKey(s,t.buffer,{name:m,namedCurve:f},!0,[h]))},function(r){throw Error("An error occurred in importPrivateKey function :"+r)}))}catch(r){return Promise.reject(r)}},w=function(r){try{try{for(var e={},n=0;n<64;n++)e["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[n]]=n;e["="]=0;for(var t=new Uint8Array(r.length),o=0,i=0;i<r.length;i+=4){var c=e[r[i+1]],s=e[r[i+2]],u=e[r[i+3]];t[o]=e[r[i]]<<2|c>>4,o++,"="!==r[i+2]&&(t[o]=c<<4|s>>2,o++),"="!==r[i+3]&&(t[o]=s<<6|u,o++)}return Promise.resolve(t.slice(0,o))}catch(r){throw Error("An error occurred in decodeBase64String function:"+r)}}catch(r){return Promise.reject(r)}},E=function(r,e){try{return Promise.resolve(g(function(){return Promise.resolve(fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).then(function(e){return Promise.resolve(e.json()).then(function(n){if(e.ok)return n;if(null!==n)throw Error("An error occurred while pinging url: "+r+",  message: "+JSON.stringify(n));throw Error("An error occurred while pinging url: "+r)})})},function(r){throw Error("An error occurred in restCall :"+r)}))}catch(r){return Promise.reject(r)}},A=function(r,e,n,t){try{return Promise.resolve(g(function(){return Promise.resolve(E(e,t)).then(function(e){var t=e.message.proposal;return Promise.resolve(w(t)).then(function(e){return Promise.resolve(p(r,e)).then(function(r){return Promise.resolve(E(n,{signedR:r[0],signedS:r[1],proposal:t})).then(function(r){return r.message.evaluate})})})})},function(r){throw Error("An error occurred while evaluateSignedTransaction :"+r)}))}catch(r){return Promise.reject(r)}},b=function(r,e,n,t,o,i,c,s,u){try{return Promise.resolve(g(function(){var a=e||B(r);return Promise.resolve(A(t,a+"/proposal",a+"/evaluate",{enrollmentID:n,cert:o,channelName:i,chainCodeName:c,transactionName:s,transactionParams:u}))},function(r){throw Error("An error occurred while evaluating transaction :"+r)}))}catch(r){return Promise.reject(r)}},S=function(r,e,n,t,o,i,c,s,u){try{return Promise.resolve(g(function(){console.log("transaction 123",r,e,n,t,o,i,c,s,u);var a=e||B(r),l=a+"/proposal",h=a+"/endorse",m=a+"/submit",f=a+"/commitstatus",v=t,g={enrollmentID:n,cert:o,channelName:i,chainCodeName:c,transactionName:s,transactionParams:u};return console.log("transaction",g),Promise.resolve(E(l,g)).then(function(r){var e="",n="",t=r.message.proposal;return Promise.resolve(w(t)).then(function(r){return Promise.resolve(p(v,r)).then(function(r){return e=r[0],n=r[1],Promise.resolve(E(h,{signedR:e,signedS:n,proposal:t})).then(function(r){var t=r.message.endorse;return Promise.resolve(w(t)).then(function(r){return Promise.resolve(p(v,r)).then(function(r){return e=r[0],n=r[1],Promise.resolve(E(m,{signedR:e,signedS:n,endorse:t})).then(function(r){var t=r.message.submit;return Promise.resolve(w(t)).then(function(r){return Promise.resolve(p(v,r)).then(function(r){return e=r[0],n=r[1],Promise.resolve(E(f,{signedR:e,signedS:n,submit:t})).then(function(r){var e=function(r){return r.message.transaction_id}(r);return e})})})})})})})})})})},function(r){throw Error("An error occurred while submiting transaction "+r)}))}catch(r){return Promise.reject(r)}},j=function(r){try{return Promise.resolve(g(function(){var e=(new TextEncoder).encode(r);return Promise.resolve(P.subtle.digest("SHA-256",e)).then(function(r){var e=Array.from(new Uint8Array(r)).map(function(r){return r.toString(16).padStart(2,"0")}).join(""),n="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t="abcdefghijklmnopqrstuvwxyz",o="!@#$%^&*+-=",i="0123456789";function c(r,e){var n=parseInt(r.slice(2*e,2*e+2),16)%s.length;return s[n]}var s=n+t+o+i,u="";u+=n[parseInt(e.slice(0,2),16)%26],u+=t[parseInt(e.slice(2,4),16)%26],u+=o[parseInt(e.slice(4,6),16)%11],u+=i[parseInt(e.slice(6,8),16)%10];for(var a=4;a<16;a++)u+=c(e,a);return u})},function(r){throw Error("An error occurred while getting secret from enrollment ID "+r)}))}catch(r){return Promise.reject(r)}},N=function(r,e,n,t,o,i){try{return Promise.resolve(g(function(){var c=(e||Y(r))+l,s={Authorization:u},a={enrollmentid:t,secret:o,csr:i,channel:n||M(r)};return Promise.resolve(fetch(c,{method:"POST",headers:s,body:JSON.stringify(a)})).then(function(r){return r.ok?Promise.resolve(r.json()).then(function(r){return r.response.pubcert}):Promise.resolve(r.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while getting certificate"+e)})})},function(r){throw Error("An error occurred while getting certificate"+r)}))}catch(r){return Promise.reject(r)}},I=function(r,e,n,t,o){try{return Promise.resolve(g(function(){if(40!==t.length)throw Error("Invalid enrollment ID: Must be 40 characters long.");var i=(e||Y(r))+a,c={Authorization:u},s={enrollmentid:t,secret:o,maxenrollments:"-1",channel:n||M(r)};return Promise.resolve(fetch(i,{method:"POST",headers:c,body:JSON.stringify(s)})).then(function(r){function e(e){return Promise.resolve(r.json()).then(function(r){return JSON.stringify(r)})}var n=function(){if(!r.ok)return Promise.resolve(r.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while doing user registration"+e)})}();return n&&n.then?n.then(e):e()})},function(r){throw Error("An error occurred while doing user registration"+r)}))}catch(r){return Promise.reject(r)}},k=function(r,e,n,t,o){try{return Promise.resolve(g(function(){if(40!==t.length)throw Error("Invalid enrollment ID: Must be 40 characters long.");return Promise.resolve(j(t)).then(function(i){var c=e||Y(r),s=c+a,h={Authorization:u},m={enrollmentid:t,secret:i,maxenrollments:"-1",channel:n||M(r)};return Promise.resolve(fetch(s,{method:"POST",headers:h,body:JSON.stringify(m)})).then(function(e){if(e.ok){var s=c+l,a={Authorization:u},h={enrollmentid:t,secret:i,csr:o,channel:n||M(r)};return Promise.resolve(fetch(s,{method:"POST",headers:a,body:JSON.stringify(h)})).then(function(r){return r.ok?Promise.resolve(r.json()).then(function(r){return r.response.pubcert}):Promise.resolve(r.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while getting certificate"+e)})})}return Promise.resolve(e.json()).then(function(r){var e=JSON.stringify(r);throw Error("An error occurred while doing user registration"+e)})})})},function(r){throw Error("An error occurred in user registration process "+r)}))}catch(r){return Promise.reject(r)}},C=function(r){try{return Promise.resolve(g(function(){var e=r.replace(/-----BEGIN PUBLIC KEY-----\r?\n|\r?\n?-----END PUBLIC KEY-----\r?\n?|\r?\n/g,"");return Promise.resolve(w(e)).then(function(r){return Promise.resolve(function(r){try{return Promise.resolve(g(function(){var e=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);return Promise.resolve(P.subtle.digest("SHA-256",e)).then(function(r){return new Uint8Array(r)})},function(r){throw Error("An error occurred while getting hashByteArray"+r)}))}catch(r){return Promise.reject(r)}}(r)).then(function(r){return Promise.resolve(function(r){try{try{for(var e=new Uint8Array(2*r.length),n=0;n<r.length;n++){var t=r[n];e[2*n]=t>>4&15,e[2*n+1]=15&t}return Promise.resolve(Array.from(e).map(function(r){return r.toString(16)}).join(""))}catch(r){throw Error("An error occurred in convertByteArrayToString function"+r)}}catch(r){return Promise.reject(r)}}(r)).then(function(r){return r.slice(-40)})})})},function(r){throw Error("An error occurred while getting enrollmentId : "+r)}))}catch(r){return Promise.reject(r)}},K=function(){try{return Promise.resolve(g(function(){return Promise.resolve(function(){try{return Promise.resolve(g(function(){return Promise.resolve(window.crypto.subtle.generateKey({name:m,namedCurve:f},!0,[h,v]))},function(r){throw Error("An error occurred while generating key pair from generateKeyPairUsingCryptoSubtle function"+r)}))}catch(r){return Promise.reject(r)}}()).then(function(r){var e=r.privateKey;return Promise.resolve(T(r.publicKey)).then(function(r){return Promise.resolve(function(r){try{return Promise.resolve(g(function(){return Promise.resolve(P.subtle.exportKey(s,r)).then(function(r){var e=String.fromCharCode.apply(null,new Uint8Array(r));return"-----BEGIN PRIVATE KEY-----\n"+btoa(e)+"\n-----END PRIVATE KEY-----\n"})},function(r){throw Error("An error occurred in exportPrivateKeyAsPem function :"+r)}))}catch(r){return Promise.reject(r)}}(e)).then(function(e){return{pemPrivateKey:e,pemPublicKey:r}})})})},function(r){throw Error("An error occurred while getting public and private key pair:"+r)}))}catch(r){return Promise.reject(r)}},T=function(r){try{return Promise.resolve(g(function(){return Promise.resolve(P.subtle.exportKey("spki",r)).then(function(r){return Promise.resolve(function(r){try{try{var e=String.fromCharCode.apply(null,new Uint8Array(r)),n=btoa(e);return Promise.resolve("-----BEGIN PUBLIC KEY-----\n"+n+"\n-----END PUBLIC KEY-----\n")}catch(r){throw Error("An error occurred while formatting base64key to pem key"+r)}}catch(r){return Promise.reject(r)}}(r))})},function(r){throw Error("An error occurred while converting publicKey from cryptoKey format to pem: "+r)}))}catch(r){return Promise.reject(r)}},O=function(t){try{return Promise.resolve(g(function(){var o=new e(i),s=r.utils.mnemonicToSeed(t),u=o.keyFromPrivate(s),a=u.getPrivate(c),l=u.getPublic(c),h=n.getKey({curve:"secp256r1",d:a}),d=n.getPEM(h,"PKCS8PRV");return Promise.resolve(function(r){try{return Promise.resolve(g(function(){for(var e=new Uint8Array(r.length/2),n=0;n<r.length;n+=2)e[n/2]=parseInt(r.substr(n,2),16);return Promise.resolve(P.subtle.importKey("raw",e,{name:m,namedCurve:f},!0,[v])).then(function(r){return Promise.resolve(T(r))})},function(r){throw Error("An error occurred while converting public key hex format to pem"+r)}))}catch(r){return Promise.reject(r)}}(l)).then(function(r){return{pemPrivateKey:d,pemPublicKey:r}})},function(r){throw Error("An error occurred while getting keypair:"+r)}))}catch(r){return Promise.reject(r)}},R=function(){try{try{var e=r.Wallet.createRandom();return Promise.resolve(e.mnemonic.phrase)}catch(r){throw Error("An error occurred while getting seedphrase: "+r)}}catch(r){return Promise.reject(r)}};P="undefined"==typeof window?require("crypto"):window.crypto;var U={Stagenet:"STAGENET",Testnet:"TESTNET",Mainnet:"MAINNET",IntegrationManinet:"INTEGRATIONMAINNET"};function D(r,e,n){try{return new t.asn1.csr.CertificationRequest({subject:{str:"/CN="+r+"/O=Your Organization/postalCode=Your Postal Code/L=Your Locality/ST=Your Province/C=IN"},sbjpubkey:n,sigalg:"SHA256withECDSA",sbjprvkey:e}).getPEM()}catch(r){throw Error("An error occurred while Creating CSR :"+r)}}function Y(r){switch(r){case U.Stagenet:return"https://dev-userreg-gov.p2eppl.com/v1";case U.IntegrationManinet:return"https://stg-userreg-gov.p2eppl.com/v1";case U.Testnet:return"https://ngl-userreg-test.kalp.network/v1";default:throw Error("An error occurred while getting network governance url :invalid environment variable passed")}}function B(r){switch(r){case U.Stagenet:return"https://stg-kalp-gateway.p2eppl.com/transaction/v1";case U.IntegrationManinet:return"https://intmainnet-kalp-gateway.p2eppl.com/transaction/v1";case U.Testnet:return"https://rpc-mumbai-test.kalp.network/transaction/v1";default:throw Error("An error occurred while getting kalp gateway url :invalid environment variable passed")}}var J=function(r,e,n,t,o,i,c,s,u){try{return Promise.resolve(g(function(){var a=e||B(r);return Promise.resolve(A(t,a+"/proposal",a+"/evaluate",{enrollmentID:n,cert:o,channelName:i,chainCodeName:c,transactionName:s,transactionParams:u}))},function(r){throw Error("An error occurred while getting balance :"+r)}))}catch(r){return Promise.reject(r)}};function M(r){try{switch(r){case U.IntegrationManinet:return"intmainnet-mailabs";case U.Stagenet:return"kalpstagenet";case U.Testnet:return"prod-test-mainnet";default:throw Error("An error occurred while getting kalp gateway url :invalid environment variable passed")}}catch(r){throw r}}export{U as Network,D as createCsr,N as enrollCsr,J as evaluateBalance,b as evaluateTransaction,C as getEnrollmentId,K as getKeyPair,O as getKeyPairFromSeedPhrase,d as getRandSvalue,j as getSecret,R as getSeedPhrase,I as register,k as registerAndEnrollUser,p as signUsingElliptic,S as submitTransaction};
